branches:
  - master
  - release

build:
  image: aplazame/nodejs-karma:0.3.3
  environment:
    - GITHUB_TOKEN=$$GITHUB_TOKEN
  commands:
    - 'sed -i "s/git@github.com:/https:\/\/$GITHUB_TOKEN:x-oauth-basic@github.com\//" bower.json'
    - 'sed -i "s/git\+ssh:\/\/github.com\/aplazame\//https:\/\/$GITHUB_TOKEN:x-oauth-basic@github.com\/aplazame\//" package.json'
    - 'npm install'
    - 'bower install --allow-root'
    - 'make test'
    - 'make build'

deploy:
  rsync:
    user: $$DEPLOY_USER
    host: dev.aplazame.com
    target: $$DEBUG_PATH
    delete: true
    recursive: true
    exclude:
      - ".git"
      - "node_modules"
      - ".bower_components"
    when:
      branch: master

  rsync:
    user: $$DEPLOY_USER
    host: aplazame.com
    target: $$RELEASE_PATH
    delete: true
    recursive: true
    exclude:
      - ".git"
      - "node_modules"
      - ".bower_components"
    when:
      branch: release

notify:
  slack:
    webhook_url: $$SLACK_WEBHOOK_URL
    username: 'drone'
    channel: 'developers'
    when:
      success: false
      failure: true
      change: true

  email:
    from: $$EMAIL_FROM
    host: $$EMAIL_HOST
    username: $$EMAIL_USERNAME
    password: $$EMAIL_PASS
    recipients:
      - dev@aplazame.com
    when:
      success: false
      failure: true
      change: true
