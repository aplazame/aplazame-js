build:
  image: aplazame/nodejs-karma:0.5.0
  environment:
    - GITHUB_TOKEN=$$GITHUB_TOKEN
  commands:
    - 'sed -i "s/git@github.com:/http:\/\/$GITHUB_TOKEN:x-oauth-basic@github.com\//g" bower.json'
    - 'echo "machine github.com login $GITHUB_TOKEN" > ~/.netrc'
    - 'make build'
    - 'ls -la'

deploy:
  rsync:
    user: ubuntu
    host: dev.aplazame.com
    target: $$DEPLOY_PATH
    delete: true
    recursive: true
    exclude:
      - ".git"
      - "node_modules"
      - ".bower_components"
    when:
      branch: master

  rsync:
    user: ubuntu
    host: aplazame.com
    target: $$DEPLOY_PATH
    delete: true
    recursive: true
    exclude:
      - ".git"
      - "node_modules"
      - ".bower_components"
    when:
      branch: release

  rsync:
    user: ubuntu
    host: demo.aplazame.org
    source: public/
    target: ~/www/demo-demo
    delete: true
    recursive: true
    when:
      branch: demo

publish:
  s3_sync:
    acl: public-read
    region: "eu-central-1"
    bucket: "cdn.aplazame.com"
    access_key: $$S3_ACCESS_KEY
    secret_key: $$S3_SECRET_KEY
    source: dist/aplazame.js
    target: /aplazame.js
    content_type:
      ".js": "application/javascript; charset=utf-8"
    metadata:
      Cache-Control: "max-age: no-cache"
      x-content-type-options: "nosniff"
      x-xss-protection: "1; mode=block"
    when:
      branch:
        - master
        - release

notify:
  slack:
    webhook_url: $$SLACK_WEBHOOK_URL
    username: 'drone'
    channel: 'developers'
    when:
      success: false
      failure: true
      change: true
      branch: master
