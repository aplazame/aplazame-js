!function(e){"use strict";function t(e){return function(t){return typeof t===e}}function r(e){return function(t){return t instanceof e}}function n(){}function a(e,t){return t?e.replace(/\{\{([^\}]+)\}\}/g,function(e,r){return t[r]}):function(t){return a(e,t)}}function o(){for(var e,t=j.call(arguments),r=j.call(arguments);r;){for(e in r)t[e]=r[e];r=j.call(arguments)}return t}function s(){for(var e,t=j.call(arguments),r=j.call(arguments);r;){if(typeof t!=typeof r&&(t=E(r)?[]:z(r)?{}:r),z(r))for(e in r)void 0!==r[e]&&(typeof t[e]!=typeof r[e]?t[e]=s(void 0,r[e]):E(t[e])?[].push.apply(t[e],r[e]):z(t[e])?t[e]=s(t[e],r[e]):t[e]=r[e]);r=j.call(arguments)}return t}function c(){return console.debug("joinPath",arguments),[].reduce.call(arguments,function(e,t,r,n){return t=r?t.replace(/^\//,""):t,t=r===n.length-1?t:t.replace(/\/$/,""),e+(r?"/":"")+t},"")}function i(e){var t=e[0].toUpperCase()+e.substr(1);return t.replace(/([a-z])([A-Z])/,function(e,t,r){return t+"-"+r})}function u(e){var t=e[0].toLowerCase()+e.substr(1);return t.replace(/([a-z])-([A-Z])/,function(e,t,r){return t+r})}function p(e,t,r){var n=e&&e.match(k);return n&&("json"===n[3]?JSON.parse(t):"xml"===n[3]?r:t)}function l(e,t){console.debug("http",e,t),t=t||{},t.headers=t.headers||{},t.url=e;var r=null,n={resolve:[],reject:[]};try{r=new XMLHttpRequest}catch(a){try{r=new ActiveXObject("Msxml2.XMLHTTP")}catch(o){r=new ActiveXObject("Microsoft.XMLHTTP")}}if(null===r)throw"Browser does not support HTTP Request";r.open((t.method||"get").toUpperCase(),e),t.withCredentials&&(r.withCredentials=!0);for(var s in t.headers)r.setRequestHeader(i(s),t.headers[s]);r.resolve=function(e){n.resolve.forEach(function(t){t(e)})},r.reject=function(e){n.reject.forEach(function(t){t(e)})};var c;return r.getHeaders=function(){return c||(c={},r.getAllResponseHeaders().replace(/\s*([^\:]+)\s*\:\s*([^\;\n]+)/g,function(e,t,r){c[u(t)]=r.trim()})),c},r.onreadystatechange=function(){if("complete"===r.readyState||4===r.readyState){var e={data:p(r.getResponseHeader("content-type"),r.responseText,r.responseXML),status:r.status,headers:r.getHeaders,xhr:r};if(r.status>=200&&r.status<300)r.resolve(e);else{if(!(r.status>=400))throw new Error("Unexpected status code "+r.status);r.reject(e)}}},r.options=t,r.send(t.data),{then:function(e,t){n.resolve.push(e),t instanceof Function&&n.reject.push(t)},error:function(e){n.reject.push(e)}}}function d(e){e=e||{};var t=e.publicKey||A.publicKey;if(!t)throw new Error("public key needs to be specified");if(e=s({},{headers:{authorization:"Bearer "+t}},e),e.version=e.version||A.version,e.sandbox=(void 0===e.sandbox?A.sandbox:e.sandbox)?".sandbox":"",e.paramsStr="",e.params)for(var r in e.params)e.paramsStr+=(e.paramsStr?"&":"?")+r+"="+encodeURIComponent(e.params[r]);return console.log("apiOptions",e),s(e,{headers:{accept:a(x.accept,e)}})}function f(e){if(!e)throw new Error("aplazame.init({options}) requires options");o(A,e),console.debug("init",e)}function m(){return A}function h(e,t){t=d(t);var r=e?c(x.host,e):x.host;return l(r+t.paramsStr,t)}function b(e,t,r){r=d(r);var n=e?c(x.host,e):x.host;return l(n+r.paramsStr,s(r,{method:"post",data:t}))}function v(e){if(!e)throw new Error("aplazame.button requires parameters");var t=[document.querySelector(e.button)];e.description&&[].push.apply(t,document.querySelectorAll(e.description)),t.forEach(function(e){e.__display=e.style.display,e.style.display="none"});var r={amount:e.amount,currency:e.currency||"EUR"};h("checkout/button",{params:r}).then(function(){t.forEach(function(e){e.style.display=e.__display})})}function y(e,t){var r=e.contentWindow.document;r.open(),r.write(t),r.close()}function g(e){e=e||{};var t="location"===e.host?location.origin:e.host;/\/$/.test(t)||(t+="/"),l(t+"iframe.html").then(function(r){document.body.style.overflow="hidden";var n=r.data.replace(/(src|href)\s*=\s*\"(?!http|\/\/)/g,'$1="'+t),a=document.createElement("iframe");if(o(a.style,w),a.frameBorder="0",document.body.appendChild(a),y(a,n),!e.merchant)throw new Error("missing merchant parameters");if(!e.merchant.public_api_key){if(!A.publicKey)throw new Error("missing public key");e.merchant.public_api_key=A.publicKey}S(window,"message",function(t){if(a){var r=t.data;if("checkout"===r.aplazame&&"merchant"===r.require)t.source.postMessage({checkout:e},"*");else if("checkout"===r.aplazame&&r.result)switch(document.body.removeChild(a),a=null,console.debug("message.aplazame",r.result),r.result){case"success":location.replace(e.merchant.success_url);break;case"cancel":location.replace(e.merchant.cancel_url)}}})},function(){console.error("checkout server",t,"should be running")})}var w={position:"fixed",top:0,left:0,width:"100%",height:"100%",background:"transparent"},x={host:"https://api.aplazame.com/",accept:"application/vnd.aplazame{{sandbox}}.v{{version}}+json"},z=t("object"),E=(t("function"),t("string"),t("number"),Array.isArray||r(Array));r(Date),r(RegExp);n.prototype={version:1,sandbox:!1};var A=new n,S=window.addEventListener?function(e,t,r){e.addEventListener(t,r,!1)}:window.attachEvent&&function(e,t,r){e.attachEvent("on"+t,r)};if(!S)throw new Error("Your Browser does not support events");var j=[].shift,k=/([^\/]+)\/([^+]+\+)?(.*)/;window.http=l;var q=document.querySelector('script[src*="aplazame.js"]');if(q){var _=q.src.split("?"),H=_&&_[1]&&_[1].match(/sandbox\=([^&]*)/);H&&f({sandbox:"true"===H[1]})}if(document.querySelector("script[data-aplazame]")){var C=document.querySelector("script[data-aplazame]"),R=C.getAttribute("data-aplazame"),L={};/\:/.test(R)?R.split(",").forEach(function(e){var t=e.match(/^([^\:]+)\:(.*)/);L[t[1].trim()]=t[2].trim()}):(R&&(L.publicKey=R),C.getAttribute("data-version")&&(L.version=Number(C.getAttribute("data-version"))),C.getAttribute("data-sandbox")&&(L.sandbox="true"===C.getAttribute("data-sandbox"))),f(L)}e.aplazame={init:f,getEnv:m,checkout:g,button:v,apiGet:h,apiPost:b}}(this),function(){var e=document.querySelector("[data-aplazame-button]");if(e){var t={button:"[data-aplazame-button]",description:"[data-aplazame-button-info]",publicKey:e.getAttribute("data-aplazame-button"),amount:e.getAttribute("data-amount"),currency:e.getAttribute("data-currency")||void 0,sandbox:e.getAttribute("data-sandbox")?"true"===e.getAttribute("data-sandbox"):void 0};aplazame.button(t),console.debug("button found",t)}}();